---
- name: Setup test environment
  ansible.builtin.include_tasks: setup.yml

- name: Run integration tests
  ansible.builtin.include_tasks: "{{ item }}"
  with_items: 
    - test_param_validation.yml

- name: Run stow module in check mode
  dandyrow.stow.stow:
    src: "{{ source_dir }}"
    dest: "{{ target_dir }}"
    package:
      - zsh
      - nvim
  check_mode: true
  register: stow_output

- name: Assert nothing was changed while in check_mode
  ansible.builtin.assert:
    that:
      - stow_output is not changed

- name: Stow nvim config files
  dandyrow.stow.stow:
    src: "{{ source_dir }}"
    dest: "{{ target_dir }}"
    package: ['nvim']
  register: stow_output

- name: Assert stow made changes
  ansible.builtin.assert:
    that:
      - stow_output is changed

- name: Check files have been stowed
  ansible.builtin.file:
    path: "{{ item }}"
    state: link
  check_mode: true
  with_items:
    - "{{ target_dir }}/.vimrc"
    - "{{ target_dir }}/plugin.lua"

- name: Stow nvim config files
  dandyrow.stow.stow:
    src: "{{ source_dir }}"
    dest: "{{ target_dir }}"
    package: ['nvim']
  register: stow_output

- name: Assert idempotency
  ansible.builtin.assert:
    that:
      - stow_output is not changed