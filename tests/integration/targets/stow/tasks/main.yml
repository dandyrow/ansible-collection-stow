---
- name: Install GNU stow
  ansible.builtin.package:
    name: stow
    state: present

- name: Create test directory structure
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  with_items:
    - "{{ target_dir }}"
    - "{{ source_dir }}"
    - "{{ source_dir }}/zsh"
    - "{{ source_dir }}/nvim"

- name: Create test files
  ansible.builtin.file:
    path: "{{ item }}"
    state: touch
  with_items: 
    - "{{ source_dir }}/zsh/.zshrc"
    - "{{ source_dir }}/nvim/.vimrc"
    - "{{ source_dir }}/nvim/plugin.lua"

- name: Test failure when directory doesn't exist
  dandyrow.stow.stow:
    src: /path/doesnt/exist
    package: 
      - zsh
  ignore_errors: true
  register: stow_output

- name: Assert module failed due to non-existant source directory
  ansible.builtin.assert:
    that:
      - "'does not exist' in stow_output.msg"

- name: Run stow module in check mode
  dandyrow.stow.stow:
    src: "{{ source_dir }}"
    dest: "{{ target_dir }}"
    package:
      - zsh
      - nvim
  check_mode: true
  register: stow_output

- name: Assert nothing was changed while in check_mode
  ansible.builtin.assert:
    that:
      - stow_output is not changed

- name: Stow nvim config files
  dandyrow.stow.stow:
    src: "{{ source_dir }}"
    dest: "{{ target_dir }}"
    package: ['nvim']
  register: stow_output

- name: Assert stow made changes
  ansible.builtin.assert:
    that:
      - stow_output is changed

- name: Check files have been stowed
  ansible.builtin.file:
    path: "{{ item }}"
    state: link
  check_mode: true
  with_items:
    - "{{ target_dir }}/.vimrc"
    - "{{ target_dir }}/plugin.lua"

- name: Stow nvim config files
  dandyrow.stow.stow:
    src: "{{ source_dir }}"
    dest: "{{ target_dir }}"
    package: ['nvim']
  register: stow_output

- name: Assert idempotency
  ansible.builtin.assert:
    that:
      - stow_output is not changed